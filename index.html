<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wheel of Names - Custom Theme</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Montserrat:wght@900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { 
            --primary-blue: #5ba3f5; 
            --soft-blue: #e6f4ff;    
            --text-main: #2d3748;    
            --nav-bg: #ffffff; 
            --accent-yellow: #f1c40f;
        }

        body { 
            font-family: 'Poppins', sans-serif; 
            display: flex; flex-direction: column; align-items: center; 
            margin: 0; padding: 0; color: var(--text-main);
            min-height: 100vh;
            background: linear-gradient(135deg, #dae9ff 0%, #fde7f3 100%);
            background-attachment: fixed;
        }

        /* --- DARK MODE STYLES --- */
        body[data-theme="dark"] {
            --primary-bg: #020617;
            --text-main: #e5e7eb;
            --nav-bg: #212121;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(30, 64, 175, 0.35) 0%, transparent 60%),
                radial-gradient(circle at right, rgba(153, 27, 27, 0.35) 0%, transparent 65%),
                linear-gradient(120deg, #020617 0%, #020617 55%, #1f2933 100%);
        }
        body[data-theme="dark"] #wheelTitleText { color: #fff; }
        body[data-theme="dark"] .modal-content { background: #1e293b !important; color: #fff !important; }
        body[data-theme="dark"] .modal-header { background: #1e293b !important; border-bottom: 1px solid #334155 !important; color: #fff !important; }
        body[data-theme="dark"] .modal-body { background: #1e293b !important; color: #fff !important; }
        body[data-theme="dark"] .modal-footer { background: #0f172a !important; border-top: 1px solid #334155 !important; }
        body[data-theme="dark"] .edit-input-group input, body[data-theme="dark"] .edit-input-group textarea, body[data-theme="dark"] #riggedInput { background: #0f172a !important; border: 1px solid #475569 !important; color: #fff !important; }
        body[data-theme="dark"] .controls-section { background: rgba(30, 41, 59, 0.95); border-color: #334155; }
        body[data-theme="dark"] #namesInput, body[data-theme="dark"] #resultsList { background: #0f172a; color: #fff; border-color: #334155; }
        body[data-theme="dark"] .auto-remove-container { background: #1e293b; border-color: #334155; color: #fff; }

        #toast-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: #1e293b;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 15px;
            min-width: 250px;
            justify-content: space-between;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
        }

        .toast-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: var(--primary-blue);
            width: 100%;
            animation: toast-timer 3s linear forwards;
        }

        @keyframes toast-timer {
            from { width: 100%; }
            to { width: 0%; }
        }

        .navbar {
            width: 100%;
            background-color: var(--nav-bg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 40px;
            box-sizing: border-box;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .nav-logo {
            font-size: 22px;
            font-weight: 800;
            color: #1e293b;
            letter-spacing: 1px;
            text-transform: uppercase;
            white-space: nowrap;
        }

        .nav-links {
            display: flex; gap: 30px; align-items: center;
        }

        .nav-item {
            display: flex; align-items: center; gap: 8px; cursor: pointer;
            font-size: 15px; font-weight: 600; color: #1e293b; 
            transition: 0.2s; user-select: none;
            white-space: nowrap;
        }
        body[data-theme="dark"] .nav-logo, body[data-theme="dark"] .nav-item { color: #fff; }

        .nav-item .icon { filter: grayscale(1) brightness(0); }
        .nav-item:hover { opacity: 0.6; }
        .nav-item input[type="checkbox"] { cursor: pointer; width: 17px; height: 17px; }

        .theme-switch-box {
            display: flex; align-items: center; background: #e2e8f0; padding: 4px;
            border-radius: 50px; cursor: pointer; width: 70px; height: 34px;
            position: relative; transition: 0.3s;
        }
        body[data-theme="dark"] .theme-switch-box { background: #334155; }
        .switch-icons { display: flex; width: 100%; justify-content: space-around; align-items: center; z-index: 1; }
        .switch-icons span { font-size: 18px; }
        .switch-knob {
            position: absolute; left: 4px; width: 26px; height: 26px;
            background: white; border-radius: 50%; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); z-index: 2;
        }
        body[data-theme="dark"] .switch-knob { transform: translateX(36px); }

        .main-container { 
            display: flex; gap: 40px; flex-wrap: wrap; justify-content: center; 
            max-width: 1400px; width: 100%; margin-top: 30px; padding-bottom: 50px; 
            align-items: flex-start;
            position: relative;
        }
        
        .wheel-container-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            width: 100%;
        }

        .wheel-header-info {
            text-align: center;
            margin-bottom: 10px;
            max-width: 90%;
        }

        #wheelTitleText { margin: 0; font-size: 32px; font-weight: 800; color: #1e293b; word-wrap: break-word; }
        #wheelDescText { margin: 5px 0 0 0; color: #64748b; font-size: 16px; word-wrap: break-word; }

        .btn-edit-circle {
            position: fixed;
            left: 30px;
            top: 100px;
            width: 60px;
            height: 60px;
            background-color: var(--primary-blue);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(91, 163, 245, 0.4);
            transition: transform 0.2s;
            z-index: 2000;
        }
        .btn-edit-circle:hover { transform: scale(1.1); }
        .btn-edit-circle span { font-size: 24px; color: white; }

        .wheel-section { position: relative; width: 700px; height: 700px; max-width: 95vw; height: auto; aspect-ratio: 1/1; filter: drop-shadow(0 20px 50px rgba(0,0,0,0.08)); }
        #canvas { background: white; border-radius: 50%; border: 12px solid #ffffff; cursor: pointer; width: 100%; height: 100%; }
        #pointer { position: absolute; top: 50%; right: -15px; transform: translateY(-50%); width: 0; height: 0; border-top: 20px solid transparent; border-bottom: 20px solid transparent; border-right: 35px solid #334155; z-index: 10; filter: drop-shadow(0 0 2px #000000); }

        .controls-section { 
            position: fixed;
            top: 80px; 
            right: 20px;
            width: 380px; 
            background: rgba(255, 255, 255, 0.95); 
            padding: 25px; 
            border-radius: 20px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); 
            border: 1px solid #e1f5fe; 
            backdrop-filter: blur(8px); 
            box-sizing: border-box; 
            z-index: 1001;
            max-height: 85vh;
            overflow-y: auto;
        }
        .controls-section.hidden-mode { display: none; }

        .tabs-header { display: flex; align-items: center; gap: 20px; margin-bottom: 15px; border-bottom: 2px solid #f1f5f9; padding-bottom: 5px; }
        .tab-item { cursor: pointer; font-weight: 600; color: #94a3b8; display: flex; align-items: center; gap: 8px; padding: 8px 0; transition: 0.3s; }
        .tab-item.active { color: var(--primary-blue); border-bottom: 2px solid var(--primary-blue); }
        .tab-count { background: #cbd5e1; color: white; border-radius: 6px; padding: 2px 8px; font-size: 11px; font-weight: 700; }
        .button-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .btn-blue { background: var(--primary-blue); color: white; border: none; padding: 12px; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.2s; box-shadow: 0 4px 12px rgba(0, 149, 255, 0.2); }
        .btn-blue:hover:not(:disabled) { background: #0076cc; transform: translateY(-2px); }
        .btn-blue:disabled { background: #cbd5e1; cursor: not-allowed; opacity: 0.6; box-shadow: none; }
        
        #namesInput, #resultsList { height: 350px; padding: 15px; border-radius: 12px; border: 1px solid #e1f5fe; overflow-y: auto; outline: none; background: white; font-size: 18px; color: #2d3748; line-height: 1.6; }

        .auto-remove-container { margin-top: 15px; padding: 12px; background: #f8fafc; border-radius: 12px; display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; border: 1px solid #f1f5f9; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal-content { background: white; width: 500px; border-radius: 24px; overflow: hidden; max-width: 90%; }
        .modal-header { background: white; color: var(--text-main); padding: 20px 25px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f1f5f9; }
        .modal-body { padding: 25px; text-align: center; }
        .modal-footer { padding: 15px 25px; background: #f8fafc; display: flex; justify-content: flex-end; gap: 10px; border-top: 1px solid #f1f5f9; }

        .gallery-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-top: 15px; }
        .gallery-item { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 12px; cursor: pointer; border: 3px solid transparent; }
        .gallery-item.selected { border-color: var(--primary-blue); }
        img.list-img { height: 50px; width: 50px; object-fit: cover; border-radius: 8px; margin-bottom: 5px; display: block; }

        @media (max-width: 1100px) { 
            .navbar { padding: 10px 15px; }
            .nav-logo { font-size: 16px; padding: 10px 5px; }
            .nav-links { gap: 15px; overflow-x: auto; padding-bottom: 5px; }
            .nav-item { font-size: 13px; }
            .theme-switch-wrapper { width: 55px; height: 28px; }
            .toggle-knob { width: 20px; height: 20px; }
            body[data-theme="dark"] .toggle-knob { transform: translateX(27px); }
            
            .main-container { flex-direction: column; padding: 0 10px; align-items: center; margin-top: 10px; } 
            .wheel-section { width: 95vw; height: 95vw; margin-bottom: 20px; } 
            .controls-section { position: relative; top: 0; right: 0; width: 100%; margin-top: 20px; box-shadow: none; border-radius: 15px; } 
            .btn-edit-circle { bottom: 20px; top: auto; right: 20px; left: auto; width: 50px; height: 50px; }
            .modal-content { width: 95%; }
        }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <nav class="navbar">
        <div class="nav-logo" id="logoClick" ondblclick="if(!spinning) document.getElementById('modalSecret').style.display='flex'">üé° WHEEL OF NAMES</div>
        <div class="nav-links">
            <div class="nav-item" id="btnNew" onclick="createNewWheel()"><span class="icon">üìÑ</span> New</div>
            <div class="nav-item" onclick="if(!spinning) document.getElementById('timerModal').style.display='flex'"><span class="icon">üé®</span> Customize</div>
            <div class="nav-item">
                <input type="checkbox" id="hideArea" onchange="toggleHide()"> 
                <label for="hideArea" style="cursor:pointer">Hide Editor</label>
            </div>
            
            <div class="theme-switch-wrapper" onclick="toggleTheme()">
                <div class="toggle-img-icons"><span>‚òÄÔ∏è</span><span>üåô</span></div>
                <div class="toggle-knob"></div>
            </div>
            <input type="number" id="spinDuration" value="10" style="display:none">
        </div>
    </nav>

    <div class="main-container">
        <button class="btn-edit-circle" id="btnPen" onclick="if(!spinning) document.getElementById('modalEditWheelInfo').style.display='flex'">
            <span>‚úèÔ∏è</span>
        </button>

        <div class="wheel-container-wrapper">
            <div class="wheel-header-info">
                <h2 id="wheelTitleText">Wheel of Names</h2>
                <p id="wheelDescText">Spin the wheel to pick a name!</p>
            </div>

            <div class="wheel-section">
                <div id="pointer"></div>
                <canvas id="canvas" width="700" height="700" onclick="handleSpinClick()"></canvas>
            </div>
        </div>

        <div class="controls-section" id="mainControls">
            <div class="tabs-header">
                <div class="tab-item active" id="tabEntries" onclick="switchTab('entries')">Entries <span class="tab-count" id="countEntries">0</span></div>
                <div class="tab-item" id="tabResults" onclick="switchTab('results')">Results <span class="tab-count" id="countResults">0</span></div>
            </div>
            
            <div id="entriesButtons">
                <div class="button-grid">
                    <button id="btnShuffle" class="btn-blue" onclick="shuffleItems()">üîÄ Shuffle</button>
                    <button id="btnSort" class="btn-blue" onclick="sortItems()">‚¨ÜÔ∏è Sort A-Z</button>
                </div>
                <button id="btnCustImg" class="btn-blue" style="width:100%; margin-bottom:10px; background: #f1f5f9; color: #475569; border: 1px dashed #cbd5e1;" onclick="if(!spinning) document.getElementById('modalType').style.display='flex'">üé® Customize Wheel Images</button>
                <div class="auto-remove-container">
                    <span style="font-size: 13px; font-weight: 600; color: #475569;">Auto-remove winner</span>
                    <input type="checkbox" id="autoRemoveToggle">
                </div>
            </div>

            <div id="resultsButtons" style="display:none">
                <button id="btnClear" class="btn-blue" style="background:#fee2e2; color:#ef4444; width:100%;" onclick="clearResults()">üóëÔ∏è Clear Data</button>
            </div>

            <div id="namesInput" contenteditable="true" oninput="syncFromVisual()">Akbar<br>Budi<br>Sarah<br>Dinda</div>
            <div id="resultsList" style="display:none"></div>
        </div>
    </div>

    <div id="modalSecret" class="modal-overlay">
        <div class="modal-content" style="width: 400px; border-radius: 20px;">
            <div class="modal-header"><h3 style="color: #f1c40f; margin:0;">ü§´ Mode Rahasia</h3></div>
            <div class="modal-body">
                <p style="font-weight: 700; color: #64748b; font-size: 13px; text-align: left; margin-bottom: 8px;">NAMA PEMENANG:</p>
                <input type="text" id="riggedInput" style="width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ccc; outline: none;" placeholder="Ketik nama...">
            </div>
            <div class="modal-footer">
                <button class="btn-blue" style="background: #94a3b8;" onclick="cancelSecret()">Cancel</button>
                <button class="btn-blue" onclick="saveSecret()">OK</button>
            </div>
        </div>
    </div>

    <div id="timerModal" class="modal-overlay">
        <div class="modal-content" style="width:400px;">
            <div class="modal-header"><h3>Spin Settings</h3></div>
            <div class="modal-body">
                <input type="range" id="timerSlider" min="1" max="60" value="10" oninput="document.getElementById('timerValue').innerText = this.value">
                <div class="timer-display"><span id="timerValue">10</span> seconds</div>
            </div>
            <div class="modal-footer">
                <button class="btn-blue" style="background: #94a3b8;" onclick="document.getElementById('timerModal').style.display='none'">Cancel</button>
                <button class="btn-blue" onclick="saveTimer()">OK</button>
            </div>
        </div>
    </div>

    <div id="modalEditWheelInfo" class="modal-overlay"><div class="modal-content"><div class="modal-header"><h3>‚úèÔ∏è Edit title</h3><span style="cursor:pointer" onclick="this.closest('.modal-overlay').style.display='none'">&times;</span></div><div class="modal-body"><div style="margin-bottom: 15px; text-align: left;"><label style="display: block; font-size: 12px; font-weight: 700; color: #64748b; margin-bottom: 5px;">TITLE</label><input type="text" id="inputNewTitle" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px;" value="Wheel of Names"></div><div style="margin-bottom: 15px; text-align: left;"><label style="display: block; font-size: 12px; font-weight: 700; color: #64748b; margin-bottom: 5px;">DESCRIPTION</label><textarea id="inputNewDesc" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px;">Spin the wheel to pick a name!</textarea></div></div><div class="modal-footer"><button class="btn-blue" onclick="saveWheelInfo()">OK</button></div></div></div>
    <div id="winnerModal" class="modal-overlay"><div class="modal-content"><div class="modal-header"><h3>Winner!</h3><span style="cursor:pointer" onclick="handleWinnerAction('close')">&times;</span></div><div class="modal-body"><div id="winnerImgContainer"></div><p id="displayWinnerName" style="font-size: 48px; font-weight: 800; color: #5ba3f5;"></p></div><div id="winnerFooter" class="modal-footer"></div></div></div>
    <div id="modalType" class="modal-overlay"><div class="modal-content"><div class="modal-header"><h3>Select Target</h3><span style="cursor:pointer" onclick="closeModals()">&times;</span></div><div class="modal-body"><div style="border: 1px solid #e2e8f0; padding: 15px; margin-bottom: 12px; cursor: pointer; border-radius: 14px;" onclick="goToStep2('bg')">üñºÔ∏è Background</div><div style="border: 1px solid #e2e8f0; padding: 15px; margin-bottom: 12px; cursor: pointer; border-radius: 14px;" onclick="goToStep2('center')">üéØ Logo</div><div style="border: 1px solid #e2e8f0; padding: 15px; margin-bottom: 12px; cursor: pointer; border-radius: 14px;" onclick="goToStep2('entry')">üçï Image Entry</div></div></div></div>
    <div id="modalSource" class="modal-overlay"><div class="modal-content"><div class="modal-header"><h3>Select Image</h3><span style="cursor:pointer" onclick="closeModals()">&times;</span></div><div class="modal-body"><div class="gallery-grid" id="galleryGrid"></div></div><div class="modal-footer"><button class="btn-blue" onclick="confirmGallerySelection()">Confirm</button></div></div></div>

    <input type="file" id="fileInput" accept="image/*" style="display:none;">
    <audio id="tickSound"><source src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3" type="audio/mpeg"></audio>
    <audio id="winSound"><source src="https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3" type="audio/mpeg"></audio>

    <script>
        const canvas = document.getElementById('canvas'), ctx = canvas.getContext('2d');
        const namesInput = document.getElementById('namesInput'), resultsList = document.getElementById('resultsList');
        const tickSound = document.getElementById('tickSound'), winSound = document.getElementById('winSound');
        const pointerEl = document.getElementById('pointer');
        const colors = ['#d50f25', '#eeb211', '#009925', '#3369e8'];
        
        let names = [], resultsArr = [], currentRotation = 0, spinning = false, lastWinnerIdx = -1, currentWinner = "";
        let wheelBg = null, centerLogo = null, activeTarget = '', selectedGalleryUrl = null;
        let idleAnimationFrame = null, hasBeenSpun = false; 

        let riggedName = null;

        function toggleTheme() {
            const body = document.body;
            const knob = document.getElementById('knobIcon');
            if (body.getAttribute('data-theme') === 'dark') {
                body.removeAttribute('data-theme'); knob.innerText = '‚òÄÔ∏è';
            } else {
                body.setAttribute('data-theme', 'dark'); knob.innerText = 'üåô';
            }
        }

        function saveSecret() {
            const val = document.getElementById('riggedInput').value.trim();
            if(val) riggedName = val;
            document.getElementById('modalSecret').style.display='none';
        }

        function cancelSecret() {
            riggedName = null; document.getElementById('riggedInput').value = "";
            document.getElementById('modalSecret').style.display='none';
        }

        function setControlsState(disabled) {
            spinning = disabled;
            document.getElementById('btnPen').disabled = disabled;
            document.getElementById('btnNew').style.opacity = disabled ? "0.3" : "1";
            namesInput.contentEditable = !disabled;
        }

        function showToast(message) {
            const container = document.getElementById("toast-container");
            const toast = document.createElement("div");
            toast.className = "toast";
            toast.innerHTML = `<span>${message}</span><span style="cursor:pointer; font-weight:bold" onclick="this.parentElement.remove()">‚úï</span><div class="toast-progress"></div>`;
            container.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; toast.style.transition = '0.5s'; setTimeout(() => toast.remove(), 500); }, 3000);
        }

        function handleWinnerAction(action) {
            winSound.pause(); winSound.currentTime = 0;
            if (action === 'remove') {
                names = names.filter(n => (n.name || n) !== (currentWinner.name || currentWinner));
                writeBack();
                showToast(`${currentWinner.name || currentWinner} terhapus`);
            }
            document.getElementById("winnerModal").style.display = "none";
        }

        function drawInstructionText(ctx, radius) {
            if (spinning) return;
            const textTop = "Klik untuk memutar", textBottom = "atau tekan ctrl+enter";
            ctx.save(); ctx.translate(radius, radius); ctx.fillStyle = "white"; ctx.font = "900 38px Montserrat, Arial, sans-serif"; ctx.textAlign = "center"; ctx.textBaseline = "middle"; ctx.strokeStyle = 'rgba(0,0,0,0.8)'; ctx.lineWidth = 4; ctx.shadowColor = "rgba(0,0,0,1)"; ctx.shadowBlur = 5;
            const dist = radius * 0.65;
            function drawCurvedPhrase(phrase, startAngle, isBottom) {
                ctx.save(); ctx.rotate(startAngle);
                let totalArcWidth = 0;
                for (let i = 0; i < phrase.length; i++) totalArcWidth += ctx.measureText(phrase[i]).width;
                const spacingFactor = 1.05, totalArcAngle = (totalArcWidth * spacingFactor) / dist;
                ctx.rotate(isBottom ? totalArcAngle / 2 : -totalArcAngle / 2);
                for (let i = 0; i < phrase.length; i++) {
                    const char = phrase[i], charWidth = ctx.measureText(char).width * spacingFactor, charAngle = charWidth / dist;
                    ctx.save(); ctx.rotate(isBottom ? -charAngle / 2 : charAngle / 2); ctx.translate(0, isBottom ? dist : -dist); ctx.strokeText(char, 0, 0); ctx.fillText(char, 0, 0); ctx.restore(); ctx.rotate(isBottom ? -charAngle : charAngle);
                }
                ctx.restore();
            }
            drawCurvedPhrase(textTop, Math.PI / 100, false); drawCurvedPhrase(textBottom, Math.PI / 100, true); ctx.restore();
        }

        function syncFromVisual() {
            if(spinning) return;
            let newItems = [];
            const temp = document.createElement('div');
            temp.innerHTML = namesInput.innerHTML.replace(/<div>/g, "\n").replace(/<\/div>/g, "").replace(/<br>/g, "\n");
            Array.from(temp.childNodes).forEach(node => {
                if(node.nodeName === "IMG") {
                    const imgObj = new Image(); imgObj.src = node.src;
                    imgObj.onload = () => drawWheel();
                    newItems.push({ name: "", image: imgObj });
                } else if(node.textContent.trim()) {
                    node.textContent.split('\n').forEach(t => { if(t.trim()) newItems.push({ name: t.trim(), image: null }); });
                }
            });
            names = newItems; document.getElementById('countEntries').innerText = names.length; drawWheel();
        }

        function drawWheel() {
            ctx.clearRect(0,0,700,700); if(names.length === 0) return;
            const radius = 350, sliceSize = (Math.PI*2) / names.length, normRot = (currentRotation % (Math.PI*2));
            let pIdx = Math.floor((Math.PI*2 - normRot) / sliceSize) % names.length;
            if(pIdx < 0) pIdx += names.length;
            pointerEl.style.borderRightColor = colors[pIdx % colors.length] || "#ccc";
            ctx.save(); ctx.translate(350,350); ctx.rotate(currentRotation);
            if(wheelBg) { ctx.save(); ctx.beginPath(); ctx.arc(0,0,340,0,Math.PI*2); ctx.clip(); ctx.drawImage(wheelBg, -350,-350,700,700); ctx.restore(); }
            names.forEach((it, i) => {
                const angle = i * sliceSize;
                if(!wheelBg) { ctx.beginPath(); ctx.fillStyle = colors[i % colors.length]; ctx.moveTo(0,0); ctx.arc(0,0,340,angle,angle+sliceSize); ctx.fill(); ctx.strokeStyle="#fff"; ctx.lineWidth = 2; ctx.stroke(); }
                ctx.save(); ctx.rotate(angle + sliceSize/2);
                if(it.image) { ctx.save(); ctx.beginPath(); ctx.arc(200, 0, 45, 0, Math.PI*2); ctx.clip(); ctx.drawImage(it.image, 155, -45, 90, 90); ctx.restore(); }
                else if(it.name) { ctx.textAlign="right"; ctx.fillStyle="#fff"; ctx.font="bold 30px sans-serif"; ctx.fillText(it.name, 320, 10); }
                ctx.restore();
            });
            if(centerLogo) { ctx.save(); ctx.beginPath(); ctx.arc(0,0,65,0,Math.PI*2); ctx.clip(); ctx.drawImage(centerLogo, -65,-65,130,130); ctx.restore(); }
            ctx.restore();
            if(!centerLogo) { ctx.save(); ctx.translate(350,350); ctx.beginPath(); ctx.arc(0,0,55,0,Math.PI*2); ctx.fillStyle="white"; ctx.fill(); ctx.fillStyle="#333"; ctx.font="bold 20px sans-serif"; ctx.textAlign="center"; ctx.fillText("SPIN", 0, 7); ctx.restore(); }
            drawInstructionText(ctx, radius);
        }

        function handleSpinClick() {
            if(spinning || names.length === 0) return;
            cancelAnimationFrame(idleAnimationFrame); hasBeenSpun = true; setControlsState(true);
            const duration = (parseFloat(document.getElementById('spinDuration').value) || 10) * 1000, sliceSize = (Math.PI*2) / names.length;
            
            let foundIdx = -1;
            if (riggedName) foundIdx = names.findIndex(it => (it.name || "").toLowerCase() === riggedName.toLowerCase());

            let extra;
            if (foundIdx !== -1) { 
                const targetAngle = (names.length - foundIdx - 0.5) * sliceSize;
                const fullRotations = Math.PI * 2 * 12;
                extra = (fullRotations + targetAngle - (currentRotation % (Math.PI * 2))); 
            }
            else { extra = (Math.PI * 2) * (12 + Math.random() * 5); }
            
            const startRot = currentRotation, start = performance.now();
            let lastTickIdx = -1;
            function frame(now) {
                const t = Math.min((now-start)/duration, 1), ease = 1 - Math.pow(1-t, 4);
                currentRotation = startRot + extra * ease;
                const cIdx = Math.floor((currentRotation % (Math.PI*2)) / sliceSize);
                if(cIdx !== lastTickIdx) { const clone = tickSound.cloneNode(); clone.volume = 0.3; clone.play().catch(()=>{}); lastTickIdx = cIdx; }
                drawWheel();
                if(t < 1) requestAnimationFrame(frame); else finishSpin();
            }
            requestAnimationFrame(frame);
        }

        function finishSpin() { spinning = false; winSound.play().catch(()=>{}); processWinner(); }

        function processWinner() {
            const sliceSize = (Math.PI*2) / names.length, normRot = (currentRotation % (Math.PI*2));
            let winIdx = Math.floor((Math.PI*2 - normRot) / sliceSize) % names.length;
            if(winIdx < 0) winIdx += names.length;
            currentWinner = names[winIdx]; resultsArr.unshift(currentWinner); updateResultsUI();
            document.getElementById('displayWinnerName').innerText = currentWinner.name || "Winner!";
            document.getElementById('winnerImgContainer').innerHTML = currentWinner.image ? `<img src="${currentWinner.image.src}" style="width:120px; border-radius:10px;">` : "";
            const isAuto = document.getElementById('autoRemoveToggle').checked, footer = document.getElementById('winnerFooter');
            if (isAuto) { footer.innerHTML = `<button class="btn-blue" onclick="handleWinnerAction('remove')">OK</button>`; setTimeout(() => handleWinnerAction('remove'), 500); }
            else footer.innerHTML = `<button class="btn-blue" onclick="handleWinnerAction('remove')">Remove</button><button onclick="handleWinnerAction('close')" style="margin-left:10px; border:none; background:none; cursor:pointer; color:#64748b;">Close</button>`;
            document.getElementById('winnerModal').style.display = 'flex';
            confetti(); setControlsState(false); drawWheel();
        }

        function writeBack() { 
            namesInput.innerHTML = ""; names.forEach(it => { if(it.image) namesInput.innerHTML += `<div><img src="${it.image.src}" class="list-img"></div>`; else namesInput.innerHTML += `<div>${it.name}</div>`; }); 
            syncFromVisual(); 
        }

        function startIdleSpin() { if (spinning || hasBeenSpun) return; currentRotation += 0.005; drawWheel(); idleAnimationFrame = requestAnimationFrame(startIdleSpin); }
        function updateResultsUI() { resultsList.innerHTML = ""; resultsArr.forEach(r => { const div = document.createElement('div'); div.style.padding="10px"; div.style.borderBottom="1px solid #eee"; div.innerText = r.name || "Image Entry"; resultsList.appendChild(div); }); document.getElementById('countResults').innerText = resultsArr.length; }
        function toggleHide() { document.getElementById('mainControls').classList.toggle('hidden-mode', document.getElementById('hideArea').checked); }
        function switchTab(t) { const isE = t === 'entries'; namesInput.style.display = isE ? 'block' : 'none'; document.getElementById('entriesButtons').style.display = isE ? 'block' : 'none'; resultsList.style.display = isE ? 'none' : 'block'; document.getElementById('resultsButtons').style.display = isE ? 'none' : 'block'; document.getElementById('tabEntries').className = isE ? 'tab-item active' : 'tab-item'; document.getElementById('tabResults').className = isE ? 'tab-item' : 'tab-item active'; }
        function closeModals() { document.getElementById('modalType').style.display='none'; document.getElementById('modalSource').style.display='none'; }
        
        function createNewWheel() { 
            if(spinning) return; namesInput.innerHTML = "Akbar<br>Budi<br>Sarah<br>Dinda"; resultsArr = []; updateResultsUI(); 
            wheelBg = null; centerLogo = null; riggedName = null;
            document.getElementById('wheelTitleText').innerText = "Wheel of Names"; document.getElementById('wheelDescText').innerText = "Spin the wheel to pick a name!";
            syncFromVisual(); 
        }

        function shuffleItems() { if(spinning) return; names.sort(()=>Math.random()-0.5); writeBack(); }
        function sortItems() { if(spinning) return; names.sort((a,b)=>(a.name||"Z").localeCompare(b.name||"Z")); writeBack(); }
        function clearResults() { resultsArr=[]; updateResultsUI(); }
        function saveTimer() { document.getElementById('spinDuration').value = document.getElementById('timerSlider').value; document.getElementById('timerModal').style.display = 'none'; }
        function saveWheelInfo() { document.getElementById('wheelTitleText').innerText = document.getElementById('inputNewTitle').value; document.getElementById('wheelDescText').innerText = document.getElementById('inputNewDesc').value; document.getElementById('modalEditWheelInfo').style.display = 'none'; }
        function goToStep2(t) { activeTarget=t; document.getElementById('modalType').style.display='none'; document.getElementById('modalSource').style.display='flex'; renderGallery(); }
        function renderGallery() { 
            const g = document.getElementById('galleryGrid'); g.innerHTML=""; const uploadBtn = document.createElement('div'); uploadBtn.innerHTML = "‚ûï<br>Upload"; uploadBtn.className = "gallery-item"; uploadBtn.style = "display:flex; align-items:center; justify-content:center; background:#f1f5f9; border:2px dashed #cbd5e1; cursor:pointer; text-align:center; font-size:12px; font-weight:bold;"; uploadBtn.onclick = () => document.getElementById('fileInput').click(); g.appendChild(uploadBtn);
            ["https://images.unsplash.com/photo-1541701494587-cb58502866ab?w=200", "https://images.unsplash.com/photo-1557683316-973673baf926?w=200", "https://images.unsplash.com/photo-1579546929518-9e396f3cc809?w=200", "https://images.unsplash.com/photo-1508615039623-a25605d2b022?w=200"].forEach(u=>{ const i=document.createElement('img'); i.src=u; i.className="gallery-item"; i.onclick=()=>{ document.querySelectorAll('.gallery-item').forEach(e=>e.classList.remove('selected')); i.classList.add('selected'); selectedGalleryUrl=u; }; g.appendChild(i); }); 
        }
        function confirmGallerySelection() { if(!selectedGalleryUrl) return; const i=new Image(); i.crossOrigin="anonymous"; i.onload=()=>{ applyImageData(i,selectedGalleryUrl); closeModals(); }; i.src=selectedGalleryUrl; }
        function applyImageData(i,u) { if(activeTarget==='bg') wheelBg=i; else if(activeTarget==='center') centerLogo=i; else { namesInput.innerHTML += `<div><img src="${u}" class="list-img"></div>`; syncFromVisual(); } drawWheel(); }
        document.getElementById('fileInput').onchange=(e)=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=(ev)=>{ const i=new Image(); i.onload=()=>{ applyImageData(i,ev.target.result); closeModals(); }; i.src=ev.target.result; }; r.readAsDataURL(f); };

        syncFromVisual(); startIdleSpin();
    </script>
</body>
</html>
