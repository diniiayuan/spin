<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wheel of Names - Custom Theme</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { 
            --primary-blue: #5ba3f5; 
            --soft-blue: #e6f4ff;    
            --text-main: #2d3748;    
            --nav-bg: #ffffff; 
            --accent-yellow: #f1c40f;
        }

        body { 
            font-family: 'Poppins', sans-serif; 
            display: flex; flex-direction: column; align-items: center; 
            margin: 0; padding: 0; color: var(--text-main);
            min-height: 100vh;
            background: linear-gradient(135deg, #dae9ff 0%, #fde7f3 100%);
            background-attachment: fixed;
        }

        /* --- NAVBAR STYLING --- */
        .navbar {
            width: 100%;
            background-color: var(--nav-bg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 40px;
            box-sizing: border-box;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .nav-logo {
            font-size: 22px;
            font-weight: 800;
            color: #1e293b;
            letter-spacing: 1px;
            text-transform: uppercase;
            white-space: nowrap;
        }

        .nav-links {
            display: flex; gap: 30px; align-items: center;
        }

        .nav-item {
            display: flex; align-items: center; gap: 8px; cursor: pointer;
            font-size: 15px; font-weight: 600; color: #1e293b; 
            transition: 0.2s; user-select: none;
            white-space: nowrap;
        }

        .nav-item .icon { filter: grayscale(1) brightness(0); }
        .nav-item:hover { opacity: 0.6; }
        .nav-item input[type="checkbox"] { cursor: pointer; width: 17px; height: 17px; }

        /* --- MAIN LAYOUT --- */
        .main-container { 
            display: flex; gap: 40px; flex-wrap: wrap; justify-content: center; 
            max-width: 1400px; width: 100%; margin-top: 30px; padding-bottom: 50px; 
            align-items: center;
        }
        
        .wheel-wrapper {
            display: flex;
            align-items: center;
            gap: 20px;
            position: relative;
        }

        /* FLOATING PEN BUTTON */
        .btn-edit-circle {
            position: fixed;
            left: 30px;
            top: 100px;
            width: 60px;
            height: 60px;
            background-color: var(--primary-blue);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(91, 163, 245, 0.4);
            transition: transform 0.2s;
            z-index: 2000;
        }
        .btn-edit-circle:hover { transform: scale(1.1); }
        .btn-edit-circle span { font-size: 24px; color: white; }

        .wheel-section { position: relative; width: 700px; height: 700px; filter: drop-shadow(0 20px 50px rgba(0,0,0,0.08)); }
        #canvas { background: white; border-radius: 50%; border: 12px solid #ffffff; cursor: pointer; max-width: 100%; height: auto; }
        #pointer { position: absolute; top: 50%; right: -25px; transform: translateY(-50%); width: 0; height: 0; border-top: 25px solid transparent; border-bottom: 25px solid transparent; border-right: 45px solid #334155; z-index: 10; filter: drop-shadow(0 0 2px #000000); }

        .controls-section { width: 380px; background: rgba(255, 255, 255, 0.95); padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); border: 1px solid #e1f5fe; backdrop-filter: blur(8px); box-sizing: border-box; }
        .controls-section.hidden-mode { display: none; }

        #wheelTitleText { margin-top:0; word-wrap: break-word; overflow-wrap: break-word; max-width: 100%; }
        #wheelDescText { color: #64748b; font-size: 14px; margin-bottom: 20px; word-wrap: break-word; overflow-wrap: break-word; max-width: 100%; }

        .tabs-header { display: flex; align-items: center; gap: 20px; margin-bottom: 15px; border-bottom: 2px solid #f1f5f9; padding-bottom: 5px; }
        .tab-item { cursor: pointer; font-weight: 600; color: #94a3b8; display: flex; align-items: center; gap: 8px; padding: 8px 0; transition: 0.3s; }
        .tab-item.active { color: var(--primary-blue); border-bottom: 2px solid var(--primary-blue); }
        .tab-count { background: #cbd5e1; color: white; border-radius: 6px; padding: 2px 8px; font-size: 11px; font-weight: 700; }
        .button-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .btn-blue { background: var(--primary-blue); color: white; border: none; padding: 12px; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.2s; box-shadow: 0 4px 12px rgba(0, 149, 255, 0.2); }
        .btn-blue:hover:not(:disabled) { background: #0076cc; transform: translateY(-2px); }
        .btn-blue:disabled { background: #cbd5e1; cursor: not-allowed; opacity: 0.6; box-shadow: none; }
        
        #namesInput, #resultsList { height: 450px; padding: 15px; border-radius: 12px; border: 1px solid #e1f5fe; overflow-y: auto; outline: none; background: white; font-size: 18px; color: var(--text-main); line-height: 1.6; }
        #namesInput[contenteditable="false"] { background-color: #f1f5f9; cursor: not-allowed; color: #94a3b8; }

        .auto-remove-container { margin-top: 15px; padding: 12px; background: #f8fafc; border-radius: 12px; display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; border: 1px solid #f1f5f9; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal-content { background: white; width: 500px; border-radius: 24px; overflow: hidden; max-width: 90%; }

        .edit-input-group { margin-bottom: 15px; text-align: left; padding: 0 25px; }
        .edit-input-group label { display: block; font-size: 12px; font-weight: 700; color: #64748b; margin-bottom: 5px; }
        .edit-input-group input, .edit-input-group textarea { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; font-family: inherit; box-sizing: border-box; }

        .modal-timer-content { background: white; color: var(--text-main); width: 450px; border-radius: 20px; padding: 30px; text-align: center; box-shadow: 0 15px 40px rgba(0,0,0,0.15); }
        .modal-timer-content h2 { margin-top: 0; font-size: 22px; font-weight: 700; color: #1e293b; }
        .modal-timer-content p { color: #64748b; font-size: 14px; margin-bottom: 30px; }
        .slider-container { width: 100%; margin: 20px 0; }
        input[type="range"] { width: 100%; -webkit-appearance: none; background: #e2e8f0; height: 6px; border-radius: 3px; outline: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; background: var(--primary-blue); border-radius: 50%; cursor: pointer; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .slider-labels { display: flex; justify-content: space-between; color: #94a3b8; font-size: 11px; margin-top: 8px; }
        .timer-display { font-size: 32px; font-weight: 700; margin: 25px 0; color: var(--primary-blue); }
        .modal-timer-footer { display: flex; gap: 12px; margin-top: 20px; }
        .btn-cancel { flex: 1; background: #f1f5f9; color: #64748b; border: none; padding: 14px; border-radius: 12px; font-weight: 600; cursor: pointer; }
        .btn-ok { flex: 1; background: var(--primary-blue); color: white; border: none; padding: 14px; border-radius: 12px; font-weight: 600; cursor: pointer; }
        .modal-header { background: white; color: var(--text-main); padding: 20px 25px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f1f5f9; }
        .modal-body { padding: 25px; text-align: center; max-height: 70vh; overflow-y: auto; }
        .modal-footer { padding: 15px 25px; background: #f8fafc; display: flex; justify-content: flex-end; gap: 10px; border-top: 1px solid #f1f5f9; }
        .option-card { border: 1px solid #e2e8f0; padding: 15px; margin-bottom: 12px; cursor: pointer; border-radius: 14px; transition: 0.2s; font-weight: 600; text-align: left; background: white; }
        .gallery-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-top: 15px; }
        .gallery-item { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 12px; cursor: pointer; border: 3px solid transparent; }
        .gallery-item.selected { border-color: var(--primary-blue); }
        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #1e293b; color: white; padding: 14px 28px; border-radius: 12px; display: none; align-items: center; gap: 15px; z-index: 9999; box-shadow: 0 10px 25px rgba(0,0,0,0.2); font-size: 14px; }
        img.list-img { height: 50px; width: 50px; object-fit: cover; border-radius: 8px; margin-bottom: 5px; display: block; }
        #fileInput { display: none; }
        #displayWinnerName { font-size: 48px !important; color: var(--primary-blue) !important; margin: 10px 0; font-weight: 700; }

        /* --- MOBILE NAVBAR REFINEMENT --- */
        @media (max-width: 1100px) { 
            .navbar { 
                flex-direction: column; 
                padding: 10px 15px; 
                gap: 10px;
                align-items: flex-start;
            }
            .nav-logo { 
                font-size: 16px; 
                margin-bottom: 5px;
            }
            .nav-links { 
                width: 100%;
                overflow-x: auto; 
                gap: 20px; 
                padding-bottom: 5px;
                scrollbar-width: none;
            }
            .nav-links::-webkit-scrollbar { display: none; }

            .nav-item { 
                font-size: 14px; 
                flex-shrink: 0;
            }

            .btn-edit-circle { 
                left: unset; 
                right: 20px; 
                top: unset; 
                bottom: 20px; 
                width: 55px; height: 55px; 
                z-index: 3000;
            } 
            .wheel-wrapper { flex-direction: column-reverse; margin-top: 10px; }
            .main-container { flex-direction: column; padding: 0 15px 50px 15px; margin-top: 10px; } 
            .wheel-section { width: 92vw; height: 92vw; max-width: 450px; max-height: 450px; } 
            #pointer { right: -15px; border-top-width: 15px; border-bottom-width: 15px; border-right-width: 30px; }
            .controls-section { width: 100%; max-width: 500px; } 
            #namesInput, #resultsList { height: 300px; font-size: 16px; }
            #displayWinnerName { font-size: 28px !important; }
        }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="nav-logo">üé° WHEEL OF NAMES</div>
        <div class="nav-links">
            <div class="nav-item" id="btnNew" onclick="createNewWheel()"><span class="icon">üìÑ</span> New</div>
            <div class="nav-item" id="btnCustTop" onclick="if(!isSpinning) document.getElementById('timerModal').style.display='flex'"><span class="icon">üé®</span> Customize</div>
            <div class="nav-item">
                <input type="checkbox" id="hideArea" onchange="toggleHide()"> 
                <label for="hideArea" style="cursor:pointer">Hide Editor</label>
            </div>
            <div class="nav-item" style="display:none;"> 
                <input type="number" id="spinDuration" value="10">
            </div>
        </div>
    </nav>

    <div class="main-container">
        <button class="btn-edit-circle" id="btnPen" onclick="if(!isSpinning) document.getElementById('modalEditWheelInfo').style.display='flex'">
            <span>‚úèÔ∏è</span>
        </button>

        <div class="wheel-wrapper">
            <div class="wheel-section">
                <div id="pointer"></div>
                <canvas id="canvas" width="700" height="700" onclick="handleSpinClick()"></canvas>
            </div>
        </div>

        <div class="controls-section" id="mainControls">
            <h2 id="wheelTitleText">Wheel of Names</h2>
            <p id="wheelDescText">Spin the wheel to pick a name!</p>

            <div class="tabs-header">
                <div class="tab-item active" id="tabEntries" onclick="switchTab('entries')">Entries <span class="tab-count" id="countEntries">0</span></div>
                <div class="tab-item" id="tabResults" onclick="switchTab('results')">Results <span class="tab-count" id="countResults">0</span></div>
            </div>
            
            <div id="entriesButtons">
                <div class="button-grid">
                    <button id="btnShuffle" class="btn-blue" onclick="shuffleItems()">üîÄ Shuffle</button>
                    <button id="btnSort" class="btn-blue" onclick="sortItems()">‚¨ÜÔ∏è Sort A-Z</button>
                </div>
                <button id="btnCustImg" class="btn-blue" style="width:100%; margin-bottom:10px; background: #f1f5f9; color: #475569; border: 1px dashed #cbd5e1; box-shadow: none;" onclick="if(!isSpinning) document.getElementById('modalType').style.display='flex'">üé® Customize Wheel Images</button>
                <div class="auto-remove-container">
                    <span style="font-size: 13px; font-weight: 600; color: #475569;">Auto-remove winner</span>
                    <input type="checkbox" id="autoRemoveToggle">
                </div>
            </div>

            <div id="resultsButtons" style="display:none">
                <button id="btnClear" class="btn-blue" style="background:#fee2e2; color:#ef4444; width:100%; margin-bottom:10px;" onclick="clearResults()">üóëÔ∏è Clear Data</button>
            </div>

            <div id="namesInput" contenteditable="true" oninput="syncFromVisual()">Akbar<br>Budi<br>Sarah<br>Dinda</div>
            <div id="resultsList" style="display:none"></div>
        </div>
    </div>

    <div id="modalEditWheelInfo" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header"><h3>‚úèÔ∏è Edit title and description</h3><span onclick="this.closest('.modal-overlay').style.display='none'" style="cursor:pointer; font-size:24px">&times;</span></div>
            <div class="modal-body" style="padding-top:20px;">
                <div class="edit-input-group"><label>TITLE</label><input type="text" id="inputNewTitle" value="Wheel of Names"></div>
                <div class="edit-input-group"><label>DESCRIPTION</label><textarea id="inputNewDesc" rows="3">Spin the wheel to pick a name!</textarea></div>
            </div>
            <div class="modal-footer"><button onclick="this.closest('.modal-overlay').style.display='none'" style="background:none; border:none; cursor:pointer; color:#64748b; font-weight:600;">Cancel</button><button class="btn-blue" style="width:auto; margin:0; padding: 8px 25px;" onclick="saveWheelInfo()">OK</button></div>
        </div>
    </div>

    <div id="timerModal" class="modal-overlay">
        <div class="modal-timer-content">
            <h2>Spin Settings</h2>
            <p>Set rotation duration (seconds)</p>
            <div class="slider-container">
                <input type="range" id="timerSlider" min="1" max="60" value="10" oninput="document.getElementById('timerValue').innerText = this.value">
                <div class="slider-labels"><span>1</span><span>10</span><span>20</span><span>30</span><span>40</span><span>50</span><span>60</span></div>
            </div>
            <div class="timer-display"><span id="timerValue">10</span> seconds</div>
            <div class="modal-timer-footer"><button class="btn-cancel" onclick="document.getElementById('timerModal').style.display='none'">Cancel</button><button class="btn-ok" onclick="saveTimer()">OK</button></div>
        </div>
    </div>

    <div id="modalType" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header"><h3>Select Target</h3><span onclick="closeModals()" style="cursor:pointer; font-size:24px">&times;</span></div>
            <div class="modal-body">
                <div class="option-card" onclick="goToStep2('bg')">üñºÔ∏è Add Wheel Background</div>
                <div class="option-card" onclick="goToStep2('center')">üéØ Add Center Logo</div>
                <div class="option-card" onclick="goToStep2('entry')">üçï Add Image Entry</div>
            </div>
        </div>
    </div>

    <div id="modalSource" class="modal-overlay">
        <div class="modal-content" style="width: 550px;">
            <div class="modal-header"><h3>Select Image</h3><span onclick="closeModals()" style="cursor:pointer; font-size:24px">&times;</span></div>
            <div class="modal-body">
                <div class="option-card" onclick="triggerFileUpload()" style="border-style: dashed; text-align: center; background: #fafafa;">üì§ Upload from Device</div>
                <div class="gallery-grid" id="galleryGrid"></div>
            </div>
            <div class="modal-footer"><button onclick="closeModals()" style="background:none; border:none; cursor:pointer; color:#64748b; font-weight:600;">Cancel</button><button class="btn-blue" style="width:auto; margin:0; padding: 8px 25px;" onclick="confirmGallerySelection()">Confirm</button></div>
        </div>
    </div>

    <div id="winnerModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header"><h3>Winner!</h3><span onclick="closeWin()" style="cursor:pointer; font-size:24px">&times;</span></div>
            <div class="modal-body"><div id="winnerImgContainer"></div><p id="displayWinnerName"></p></div>
            <div class="modal-footer" id="winnerFooter"></div>
        </div>
    </div>

    <div id="toast" class="toast"><span id="toastMsg"></span></div>
    <input type="file" id="fileInput" accept="image/*">
    <audio id="tickSound"><source src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3" type="audio/mpeg"></audio>
    <audio id="winSound"><source src="https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3" type="audio/mpeg"></audio>

    <script>
        const canvas = document.getElementById('canvas'), ctx = canvas.getContext('2d');
        const namesInput = document.getElementById('namesInput'), resultsList = document.getElementById('resultsList');
        const tickSound = document.getElementById('tickSound'), winSound = document.getElementById('winSound');
        const toast = document.getElementById('toast'), toastMsg = document.getElementById('toastMsg');
        const pointerEl = document.getElementById('pointer');
        const colors = ['#d50f25', '#eeb211', '#009925', '#3369e8'];
        
        let items = [], resultsArr = [], currentRotation = 0, isSpinning = false, lastWinnerIdx = -1;
        let wheelBg = null, centerLogo = null, activeTarget = '', selectedGalleryUrl = null;
        let idleAnimationFrame = null, hasBeenSpun = false; 

        function setControlsState(disabled) {
            isSpinning = disabled;
            document.getElementById('btnShuffle').disabled = disabled;
            document.getElementById('btnSort').disabled = disabled;
            document.getElementById('btnCustImg').disabled = disabled;
            document.getElementById('btnPen').disabled = disabled;
            document.getElementById('btnNew').style.opacity = disabled ? "0.3" : "1";
            document.getElementById('btnNew').style.pointerEvents = disabled ? "none" : "auto";
            document.getElementById('btnCustTop').style.opacity = disabled ? "0.3" : "1";
            document.getElementById('btnCustTop').style.pointerEvents = disabled ? "none" : "auto";
            document.getElementById('autoRemoveToggle').disabled = disabled;
            namesInput.contentEditable = !disabled;
        }

        function saveWheelInfo() {
            document.getElementById('wheelTitleText').innerText = document.getElementById('inputNewTitle').value;
            document.getElementById('wheelDescText').innerText = document.getElementById('inputNewDesc').value;
            document.getElementById('modalEditWheelInfo').style.display = 'none';
        }

        const abstractImages = ["https://images.unsplash.com/photo-1541701494587-cb58502866ab?w=200", "https://images.unsplash.com/photo-1557683316-973673baf926?w=200", "https://images.unsplash.com/photo-1579546929518-9e396f3cc809?w=200", "https://images.unsplash.com/photo-1508615039623-a25605d2b022?w=200", "https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?w=200", "https://images.unsplash.com/photo-1550684848-fac1c5b4e853?w=200", "https://images.unsplash.com/photo-1511447333015-45b65e60f6d5?w=200", "https://images.unsplash.com/photo-1558591710-4b4a1ae0f04d?w=200"];

        function saveTimer() {
            const val = document.getElementById('timerSlider').value;
            document.getElementById('spinDuration').value = val;
            document.getElementById('timerModal').style.display = 'none';
            showToast("Duration saved: " + val + " seconds");
        }

        function showToast(msg) { toastMsg.innerText = msg; toast.style.display = 'flex'; setTimeout(() => { toast.style.display = 'none'; }, 3000); }

        function createNewWheel() {
            if(isSpinning) return;
            if(confirm("Create new wheel? All current data will be cleared.")) {
                wheelBg = null;
                centerLogo = null;
                namesInput.innerHTML = "Akbar<br>Budi<br>Sarah<br>Dinda";
                resultsArr = [];
                updateResultsUI();
                syncFromVisual();
                hasBeenSpun = false;
                startIdleSpin();
            }
        }

        function syncFromVisual() {
            if(isSpinning) return;
            let newItems = [];
            const temp = document.createElement('div');
            temp.innerHTML = namesInput.innerHTML.replace(/<div>/g, "\n").replace(/<\/div>/g, "").replace(/<br>/g, "\n");
            Array.from(temp.childNodes).forEach(node => {
                if(node.nodeName === "IMG") {
                    const imgObj = new Image(); imgObj.src = node.src;
                    imgObj.onload = () => drawWheel();
                    newItems.push({ name: "", image: imgObj });
                } else if(node.textContent.trim()) {
                    node.textContent.split('\n').forEach(t => { if(t.trim()) newItems.push({ name: t.trim(), image: null }); });
                }
            });
            items = newItems;
            document.getElementById('countEntries').innerText = items.length;
            drawWheel();
        }

        function drawWheel() {
            ctx.clearRect(0,0,700,700);
            if(items.length === 0) return;
            const sliceSize = (Math.PI*2) / items.length;
            const normRot = (currentRotation % (Math.PI*2));
            let pIdx = Math.floor((Math.PI*2 - normRot) / sliceSize) % items.length;
            if(pIdx < 0) pIdx += items.length;
            pointerEl.style.borderRightColor = colors[pIdx % colors.length] || "#ccc";

            ctx.save(); ctx.translate(350,350); ctx.rotate(currentRotation);
            if(wheelBg) {
                ctx.save(); ctx.beginPath(); ctx.arc(0,0,340,0,Math.PI*2); ctx.clip();
                ctx.drawImage(wheelBg, -350,-350,700,700); ctx.restore();
            }
            items.forEach((it, i) => {
                const angle = i * sliceSize;
                if(!wheelBg) {
                    ctx.beginPath(); ctx.fillStyle = colors[i % colors.length]; ctx.moveTo(0,0);
                    ctx.arc(0,0,340,angle,angle+sliceSize); ctx.fill();
                    ctx.strokeStyle="#fff"; ctx.lineWidth = 2; ctx.stroke();
                }
                ctx.save(); ctx.rotate(angle + sliceSize/2);
                if(it.image) {
                    ctx.save(); ctx.beginPath(); ctx.arc(200, 0, 45, 0, Math.PI*2); ctx.clip();
                    ctx.drawImage(it.image, 155, -45, 90, 90); ctx.restore();
                } else if(it.name) {
                    let fontSize = 32; ctx.font = `bold ${fontSize}px sans-serif`;
                    let textWidth = ctx.measureText(it.name).width;
                    while (textWidth > 240 && fontSize > 8) { fontSize--; ctx.font = `bold ${fontSize}px sans-serif`; textWidth = ctx.measureText(it.name).width; }
                    ctx.textAlign="right"; ctx.fillStyle="#fff"; ctx.fillText(it.name, 320, fontSize/3);
                }
                ctx.restore();
            });
            if(centerLogo) {
                ctx.save(); ctx.beginPath(); ctx.arc(0,0,65,0,Math.PI*2); ctx.clip();
                ctx.drawImage(centerLogo, -65,-65,130,130); ctx.restore();
            }
            ctx.restore();
            if(!centerLogo) {
                ctx.save(); ctx.translate(350,350); ctx.beginPath(); ctx.arc(0,0,55,0,Math.PI*2);
                ctx.fillStyle="white"; ctx.fill(); ctx.fillStyle="#333"; ctx.font="bold 20px sans-serif";
                ctx.textAlign="center"; ctx.fillText("SPIN", 0, 7); ctx.restore();
            }
        }

        function startIdleSpin() {
            if (isSpinning || hasBeenSpun) return;
            currentRotation += 0.005; 
            drawWheel();
            idleAnimationFrame = requestAnimationFrame(startIdleSpin);
        }

        function handleSpinClick() {
            if(isSpinning || items.length === 0) return;
            cancelAnimationFrame(idleAnimationFrame);
            hasBeenSpun = true; setControlsState(true);
            const duration = (parseFloat(document.getElementById('spinDuration').value) || 10) * 1000;
            const extra = (Math.PI*2) * (15 + Math.random()*5);
            const startRot = currentRotation, start = performance.now();
            let lastTick = -1;
            function frame(now) {
                const t = Math.min((now-start)/duration, 1);
                const ease = 1 - Math.pow(1-t, 4);
                currentRotation = startRot + extra * ease;
                const currentIdx = Math.floor(((currentRotation % (Math.PI*2))/(Math.PI*2)) * items.length);
                if(currentIdx !== lastTick) { tickSound.currentTime = 0; tickSound.play().catch(()=>{}); lastTick = currentIdx; }
                drawWheel();
                if(t < 1) requestAnimationFrame(frame);
                else { winSound.play().catch(()=>{}); processWinner(); }
            }
            requestAnimationFrame(frame);
        }

        function processWinner() {
            const sliceSize = (Math.PI*2) / items.length;
            const normRot = (currentRotation % (Math.PI*2));
            let winIdx = Math.floor((Math.PI*2 - normRot) / sliceSize) % items.length;
            if(winIdx < 0) winIdx += items.length;
            const win = items[winIdx];
            lastWinnerIdx = winIdx;
            resultsArr.unshift(win); updateResultsUI();
            document.getElementById('displayWinnerName').innerText = win.name || "Winner!";
            document.getElementById('winnerImgContainer').innerHTML = win.image ? `<img src="${win.image.src}" style="width:120px; border-radius:10px; margin-bottom:15px">` : "";
            const isAuto = document.getElementById('autoRemoveToggle').checked;
            const footer = document.getElementById('winnerFooter');
            if (isAuto) {
                footer.innerHTML = `<button class="btn-blue" style="width:100%; margin:0;" onclick="closeWin()">OK</button>`;
                setTimeout(() => { items.splice(lastWinnerIdx, 1); writeBack(); }, 500);
            } else {
                footer.innerHTML = `<button onclick="closeWin()" style="background:none; border:none; cursor:pointer; color:#64748b; font-weight:600;">Close</button><button class="btn-blue" style="width:auto; margin:0;" onclick="removeWinner()">Remove Winner</button>`;
            }
            document.getElementById('winnerModal').style.display = 'flex';
            confetti(); setControlsState(false);
        }

        function updateResultsUI() {
            resultsList.innerHTML = "";
            resultsArr.forEach(r => {
                const div = document.createElement('div'); div.style.padding="10px"; div.style.borderBottom="1px solid #eee";
                if(r.image) { const img = r.image.cloneNode(); img.style.height="45px"; div.appendChild(img); }
                else div.innerText = r.name;
                resultsList.appendChild(div);
            });
            document.getElementById('countResults').innerText = resultsArr.length;
        }

        function removeWinner() { items.splice(lastWinnerIdx, 1); writeBack(); closeWin(); showToast("Winner removed!"); }
        
        function writeBack() { 
            namesInput.innerHTML = ""; 
            items.forEach(it => { 
                if(it.image) { 
                    const wrapper = document.createElement('div'); const img = it.image.cloneNode(); img.className="list-img"; 
                    wrapper.appendChild(img); namesInput.appendChild(wrapper); 
                } else namesInput.innerHTML += `<div>${it.name}</div>`; 
            }); 
            syncFromVisual(); 
        }

        function toggleHide() { document.getElementById('mainControls').classList.toggle('hidden-mode', document.getElementById('hideArea').checked); }
        function switchTab(t) { const isE = t === 'entries'; namesInput.style.display = isE ? 'block' : 'none'; document.getElementById('entriesButtons').style.display = isE ? 'block' : 'none'; resultsList.style.display = isE ? 'none' : 'block'; document.getElementById('resultsButtons').style.display = isE ? 'none' : 'block'; document.getElementById('tabEntries').className = isE ? 'tab-item active' : 'tab-item'; document.getElementById('tabResults').className = isE ? 'tab-item' : 'tab-item active'; }
        function goToStep2(t) { activeTarget=t; document.getElementById('modalType').style.display='none'; document.getElementById('modalSource').style.display='flex'; renderGallery(); }
        function renderGallery() { const g = document.getElementById('galleryGrid'); g.innerHTML=""; abstractImages.forEach(u=>{ const i=document.createElement('img'); i.src=u; i.className="gallery-item"; i.onclick=()=>{ document.querySelectorAll('.gallery-item').forEach(e=>e.classList.remove('selected')); i.classList.add('selected'); selectedGalleryUrl=u; }; g.appendChild(i); }); }
        function confirmGallerySelection() { if(!selectedGalleryUrl) return; const i=new Image(); i.crossOrigin="anonymous"; i.onload=()=>{ applyImageData(i,selectedGalleryUrl); closeModals(); }; i.src=selectedGalleryUrl; }
        function applyImageData(i,u) { if(activeTarget==='bg') wheelBg=i; else if(activeTarget==='center') centerLogo=i; else { const w=document.createElement('div'); const li=document.createElement('img'); li.src=u; li.className="list-img"; w.appendChild(li); namesInput.appendChild(w); syncFromVisual(); } drawWheel(); }
        function triggerFileUpload() { document.getElementById('fileInput').click(); }
        
        document.getElementById('fileInput').onchange=(e)=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=(ev)=>{ const i=new Image(); i.onload=()=>{ applyImageData(i,ev.target.result); closeModals(); }; i.src=ev.target.result; }; r.readAsDataURL(f); };
        function shuffleItems() { if(isSpinning) return; items.sort(()=>Math.random()-0.5); writeBack(); }
        function sortItems() { if(isSpinning) return; items.sort((a,b)=>(a.name||"Z").localeCompare(b.name||"Z")); writeBack(); }
        function clearResults() { resultsArr=[]; updateResultsUI(); }
        function closeModals() { document.getElementById('modalType').style.display='none'; document.getElementById('modalSource').style.display='none'; }
        function closeWin() { document.getElementById('winnerModal').style.display='none'; }

        syncFromVisual();
        startIdleSpin();
    </script>
</body>
</html>
